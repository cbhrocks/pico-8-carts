pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
 -- enable mouse
	poke(0x5f2d, 1)
	reset()
end

function check_for_win()
 for a = 1,3 do
  if p[a] != "" and p[a] == p[a + 3] and p[a] == p[a + 6] then
   finished = true
   winner = p[a]
  end
  
  b = (a - 1) * 3
  
  if p[b + 1] != "" and p[b + 1] == p[b + 2] and p[b + 1] == p[b + 3] then
     finished = true
     winner = p[b + 1]
  end
 end

// diagonal 1
 if p[1] != "" and p[1] == p[5] and p[1] == p[9] then
   finished = true
   winner = p[1]
 end

// diagonal 2
 if p[3] != "" and p[3] == p[5] and p[3] == p[7] then
   finished = true
   winner = p[3]
 end
 
 draw = true
 
 for c = 1,8 do
  if p[c] == "" then
   draw = false
   break
  end
 end
 
 if finished != true and draw then
  finished = true
 end
end

function reset()
 p = {"", "", "", "", "", "", "", "", ""}
 finished = false
 winner = ""
 delay = 0
 down = false
 stimer = 0
 first_frame = 0
 last_frame = 1
 cur_frame = first_frame
 ani_speed = 10
 
 music(0)
end

function _update()
 if (delay > 0) then
  delay = delay - 1
  
  if (delay <= 0) then
   reset()
  end
 end
 
 if stimer < ani_speed then
  stimer += 1
 else
  if cur_frame < last_frame then
   cur_frame += 1
  else
   cur_frame = first_frame
  end
  stimer = 0
 end

 mousex = stat(32)
 mousey = stat(33)
 
 mousecol = flr(mousex/42.666)
 mouserow = flr((mousey/42.666)%3)
 
 squarenum = ((mouserow * 3) + mousecol) + 1
 
 if (down and stat(34) == 0) then
  down = false
 end
 
 if ((not down) and stat(34) == 1) then
  down = true
  
  
  if (p[squarenum] == "") then
   p[squarenum] = "0"
   check_for_win()
   
   if (not finished) then
    cpu_move()
    check_for_win()
   end
   
   if (finished and delay <=0) then
    delay = 60
   end
  end
 end
end

function cpu_move()
  local empty = 0

  for num = 0,8 do
   if (p[num + 1] == "") then
    empty = empty + 1
   end
  end

  target = flr(rnd(empty)) + 1
  empty = 0

  for num = 0,8 do
   if (p[num + 1] == "") then
    empty = empty + 1

    if (empty == target) then
      p[num + 1] = "x"
      return
    end
   end
  end
end

function grid_to_coord(grid)
 return (42.666 * (grid + 1)) - (42.666 / 2)
end

function _draw()
 cls()
 draw_grid()
 
 for num = 0,8 do
  draw_square(num)
 end
 
 if (p[square_num] == "") then
  draw_nought(grid_to_coord(mousecol), grid_to_coord(mouserow))
 end
 
 if (finished) then
  rectfill(28, 50, 100, 78, 2)
  color(6)
  print("finished", 48, 58)
  
  if (winner != "") then
   print(""..winner.." is the winner!", 32, 70)
  else
   print("game was a draw.", 30, 70)
  end
 end
 
 draw_cursor(mousex, mousey, 4)
 
 print("delay: "..delay.."", 0, 0) 
end

function draw_cursor(x, y, size)
 line(x, y - size, x, y + size)
 line(x - size, y, x + size, y)
end

function draw_grid()
 line(42, 0, 42, 127)
 line(85, 0, 85, 127)
 
 line(0, 42, 127, 42)
 line(0, 85, 127, 85)
end

function draw_nought(x,y)
 --circ(x, y, 10)
 spr(cur_frame*2+4,x-8,y-8,2,2)
end

function draw_cross(x, y)
 spr(cur_frame*2,x-8,y-8,2,2)
 --line(x - 10, y - 10, x + 10, y + 10)
 --line(x + 10, y - 10, x - 10, y + 10)
end

function draw_square(num)
 local x = grid_to_coord(num % 3)
 local y = grid_to_coord(flr(num / 3))
 if (p[num + 1] == "0") then
  draw_nought(x,y)
 end
 
 if (p[num + 1] == "x") then
  draw_cross(x,y)
 end
end
__gfx__
70000000000000078000000000000008000007777770000000000888888000000000000000000000000000000000000000000000000000000000000000000000
07000000000000700800000000000080000770000007700000088000000880000000000000000000000000000000000000000000000000000000000000000000
00700000000007000080000000000800007000000000070000800000000008000000000000000000000000000000000000000000000000000000000000000000
00070000000070000008000000008000070000000000007008000000000000800000000000000000000000000000000000000000000000000000000000000000
00007000000700000000800000080000070000000000007008000000000000800000000000000000000000000000000000000000000000000000000000000000
00000700007000000000080000800000700000000000000780000000000000080000000000000000000000000000000000000000000000000000000000000000
00000070070000000000008008000000700000000000000780000000000000080000000000000000000000000000000000000000000000000000000000000000
00000007700000000000000880000000700000000000000780000000000000080000000000000000000000000000000000000000000000000000000000000000
00000007700000000000000880000000700000000000000780000000000000080000000000000000000000000000000000000000000000000000000000000000
00000070070000000000008008000000700000000000000780000000000000080000000000000000000000000000000000000000000000000000000000000000
00000700007000000000080000800000700000000000000780000000000000080000000000000000000000000000000000000000000000000000000000000000
00007000000700000000800000080000070000000000007008000000000000800000000000000000000000000000000000000000000000000000000000000000
00070000000070000008000000008000070000000000007008000000000000800000000000000000000000000000000000000000000000000000000000000000
00700000000007000080000000000800007000000000070000800000000008000000000000000000000000000000000000000000000000000000000000000000
07000000000000700800000000000080000770000007700000088000000880000000000000000000000000000000000000000000000000000000000000000000
70000000000000078000000000000008000007777770000000000888888000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
010e00000c153101001110013100246250c153241003f7000c1531b1000c15300100246251d100270151d1000c1531f1003f70020100246250c1531b100277000c153241000c153271002462500100270153f200
010e00000214002120020100214502120020100214002125020100214502120020100214002125020400212102140021200201002145021200201002140021250201002145021200201002140021200204002121
010e00003f2001670016700167001970019700197000f7000f7000f7001670016700167000f70000000000003f200000000000000000000000000000000000003f20000000000000000000000000000000000000
001000001410714107131071310713107131071310713107131071310714107141071410014100141001410014100141001410014100141001410014100151001510015100151001510015100151001510015100
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002000001895000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
03 00010244

